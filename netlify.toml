# =====================================================
# Configuration Netlify - KiloLab
# =====================================================

[build]
  # Commande de build Vite
  command = "npm run build"

  # Dossier de sortie (Vite build output)
  publish = "dist"

  # Dossier des fonctions serverless
  functions = "netlify/functions"

# =====================================================
# Redirects & Rewrites
# =====================================================

# SPA Routing - Toutes les routes non-fichiers vont vers index.html
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  conditions = {Role = ["*"]}
  force = false

# API Functions - Route /api/* vers les Netlify Functions
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# =====================================================
# Headers de sécurité
# =====================================================

[[headers]]
  for = "/*"
  [headers.values]
    # Security headers
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"

    # Cache pour les assets statiques (1 an)
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/index.html"
  [headers.values]
    # Pas de cache pour index.html (toujours récupérer la dernière version)
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    # CORS pour les fonctions API
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization"

# =====================================================
# Variables d'environnement (à configurer dans Netlify UI)
# =====================================================
# VITE_SUPABASE_URL=https://dhecegehcjelbxydeolg.supabase.co
# VITE_SUPABASE_ANON_KEY=<votre_anon_key>
# VITE_STRIPE_PUBLISHABLE_KEY=<votre_publishable_key>
# STRIPE_SECRET_KEY=<votre_secret_key>
# URL=<votre_url_netlify> (auto-rempli par Netlify)

# =====================================================
# Build settings avancés
# =====================================================

[build.environment]
  # Version Node.js
  NODE_VERSION = "18"

  # Installer les deps avant build
  NPM_FLAGS = "--legacy-peer-deps"

# =====================================================
# Fonctions serverless
# =====================================================

[functions]
  # Timeout des fonctions (max 10s pour le plan gratuit)
  timeout = 10

  # Node version
  node_bundler = "esbuild"

# =====================================================
# Dev server local (netlify dev)
# =====================================================

[dev]
  command = "npm run dev"
  port = 5173
  targetPort = 5173
  framework = "#custom"
  autoLaunch = false
